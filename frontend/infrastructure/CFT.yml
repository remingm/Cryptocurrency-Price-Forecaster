AWSTemplateFormatVersion: "2010-09-09"

Description: >
  Creates the infrastructure to host and expose a Single Page Application:
      - An Amazon CloudFront distribution to expose the application
Parameters: 
  BucketStackName:
    Description: Name of an active CloudFormation Stack that holds the S3 bucket and OAI  for the front end 
    Type: String
    Default: front-end-s3-buckets
Resources:
  CFDistribution:
    Type: "AWS::CloudFront::Distribution"
    DependsOn:
      - CFOriginAccessIdentity
    Properties:
      DistributionConfig:
        Origins:
          - DomainName: !Sub "stonkpix-frontend.s3.us-west-2.amazonaws.com"
            Id: myS3Origin
            S3OriginConfig:
              OriginAccessIdentity: Fn::ImportValue: !Sub: "origin-access-identity/cloudfront/${BucketStackName}-OriginAccessIdentity"
        Enabled: "true"
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          TargetOriginId: myS3Origin
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6 # CachingOptimized
          OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf # CORS-S3Origin
          ViewerProtocolPolicy: redirect-to-https
        PriceClass: PriceClass_All
        Logging:
          Bucket: !Sub "stonkpix-frontend-logs.s3.us-west-2.amazonaws.com"
          Prefix: "cloudfront-access-logs"
